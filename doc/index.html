<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>Home - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="module-support_errors-InvalidNonceError.html">InvalidNonceError</a></li><li><a href="module-support_nonceManager-Account.html">Account</a><ul class='methods'><li data-type='method'><a href="module-support_nonceManager-Account.html#acquireNonce">acquireNonce</a></li><li data-type='method'><a href="module-support_nonceManager-Account.html#clear">clear</a></li><li data-type='method'><a href="module-support_nonceManager-Account.html#releaseNonce">releaseNonce</a></li></ul></li></ul><h3>Modules</h3><ul><li><a href="module-escrow.html">escrow</a><ul class='methods'><li data-type='method'><a href="module-escrow.html#.calculatePlacementId">calculatePlacementId</a></li><li data-type='method'><a href="module-escrow.html#.place">place</a></li><li data-type='method'><a href="module-escrow.html#.placeBatch">placeBatch</a></li><li data-type='method'><a href="module-escrow.html#.refund">refund</a></li><li data-type='method'><a href="module-escrow.html#.refundBatch">refundBatch</a></li><li data-type='method'><a href="module-escrow.html#.release">release</a></li><li data-type='method'><a href="module-escrow.html#.releaseBatch">releaseBatch</a></li><li data-type='method'><a href="module-escrow.html#.setFeeRate">setFeeRate</a></li><li data-type='method'><a href="module-escrow.html#.setTimeoutThreshold">setTimeoutThreshold</a></li><li data-type='method'><a href="module-escrow.html#.timeoutThreshold">timeoutThreshold</a></li><li data-type='method'><a href="module-escrow.html#.verify">verify</a></li><li data-type='method'><a href="module-escrow.html#.verifyBatch">verifyBatch</a></li><li data-type='method'><a href="module-escrow.html#.verifyPlacement">verifyPlacement</a></li><li data-type='method'><a href="module-escrow.html#~addPlacementReturnValue">addPlacementReturnValue</a></li><li data-type='method'><a href="module-escrow.html#~createEscrowPlaceTransactions">createEscrowPlaceTransactions</a></li><li data-type='method'><a href="module-escrow.html#~normalizeScopeRequestId">normalizeScopeRequestId</a></li></ul></li><li><a href="module-idvRegistry.html">idvRegistry</a><ul class='methods'><li data-type='method'><a href="module-idvRegistry.html#.exists">exists</a></li><li data-type='method'><a href="module-idvRegistry.html#.get">get</a></li><li data-type='method'><a href="module-idvRegistry.html#.set">set</a></li><li data-type='method'><a href="module-idvRegistry.html#~assertNotEmpty">assertNotEmpty</a></li></ul></li><li><a href="module-ontology.html">ontology</a><ul class='methods'><li data-type='method'><a href="module-ontology.html#.add">add</a></li><li data-type='method'><a href="module-ontology.html#.deprecate">deprecate</a></li><li data-type='method'><a href="module-ontology.html#.deprecateById">deprecateById</a></li><li data-type='method'><a href="module-ontology.html#.getAll">getAll</a></li><li data-type='method'><a href="module-ontology.html#.getById">getById</a></li><li data-type='method'><a href="module-ontology.html#.getByTypeNameVersion">getByTypeNameVersion</a></li><li data-type='method'><a href="module-ontology.html#.getIdByTypeNameVersion">getIdByTypeNameVersion</a></li><li data-type='method'><a href="module-ontology.html#.parseExternalId">parseExternalId</a></li><li data-type='method'><a href="module-ontology.html#.parseExternalId">parseExternalId</a></li><li data-type='method'><a href="module-ontology.html#~assertNotEmpty">assertNotEmpty</a></li><li data-type='method'><a href="module-ontology.html#~mapCredentialItemRecord">mapCredentialItemRecord</a></li></ul></li><li><a href="module-pricing.html">pricing</a><ul class='methods'><li data-type='method'><a href="module-pricing.html#.deletePrice">deletePrice</a></li><li data-type='method'><a href="module-pricing.html#.getAllPrices">getAllPrices</a></li><li data-type='method'><a href="module-pricing.html#.getPrice">getPrice</a></li><li data-type='method'><a href="module-pricing.html#.setPrice">setPrice</a></li><li data-type='method'><a href="module-pricing.html#~checkPriceIsSet">checkPriceIsSet</a></li><li data-type='method'><a href="module-pricing.html#~mapCredentialItemPrice">mapCredentialItemPrice</a></li></ul></li><li><a href="module-support_asserts.html">support/asserts</a><ul class='methods'><li data-type='method'><a href="module-support_asserts.html#.assertAddress">assertAddress</a></li><li data-type='method'><a href="module-support_asserts.html#.assertAmount">assertAmount</a></li><li data-type='method'><a href="module-support_asserts.html#.assertCredentialItemPrice">assertCredentialItemPrice</a></li><li data-type='method'><a href="module-support_asserts.html#.assertCredentialItems">assertCredentialItems</a></li><li data-type='method'><a href="module-support_asserts.html#.assertCredentialItemType">assertCredentialItemType</a></li></ul></li><li><a href="module-support_errors.html">support/errors</a><ul class='methods'><li data-type='method'><a href="module-support_errors.html#~mapError">mapError</a></li></ul></li><li><a href="module-support_nonceManager.html">support/nonceManager</a><ul class='methods'><li data-type='method'><a href="module-support_nonceManager.html#.clearAccounts">clearAccounts</a></li><li data-type='method'><a href="module-support_nonceManager.html#.getAccount">getAccount</a></li><li data-type='method'><a href="module-support_nonceManager.html#.getNonceForAccount">getNonceForAccount</a></li><li data-type='method'><a href="module-support_nonceManager.html#~getTransactionCount">getTransactionCount</a></li><li data-type='method'><a href="module-support_nonceManager.html#~inspectTxPool">inspectTxPool</a></li></ul></li><li><a href="module-support_tx.html">support/tx</a><ul class='methods'><li data-type='method'><a href="module-support_tx.html#~assertCodeAtAddress">assertCodeAtAddress</a></li><li data-type='method'><a href="module-support_tx.html#~fallbackToAutodetectDeployedContract">fallbackToAutodetectDeployedContract</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#destructArray">destructArray</a></li><li><a href="global.html#getTransactionPoolStatus">getTransactionPoolStatus</a></li><li><a href="global.html#handleSendError">handleSendError</a></li><li><a href="global.html#searchTxPoolContentResult">searchTxPoolContentResult</a></li><li><a href="global.html#send">send</a></li><li><a href="global.html#sendChain">sendChain</a></li><li><a href="global.html#sendPlatformCoin">sendPlatformCoin</a></li><li><a href="global.html#sendRawTransaction">sendRawTransaction</a></li><li><a href="global.html#sendTransaction">sendTransaction</a></li><li><a href="global.html#signAndSend">signAndSend</a></li></ul>
</nav>

<div id="main">
    

    



    









    


    <section class="readme">
        <article><h1>civic-tx</h1><p>This is the JavaScript client library for the Civic Marketplace. It provides an interface for all capabilities on the blockchain, including accessing smart contract data, sending transactions (modifying blockchain data, smart contract state), exchanging CVC tokens and exchanging ETH (aka platform coin).</p>
<h2>Getting started</h2><h3>Terminology</h3><p>We use the standard Civic terms for roles on the network:</p>
<p><strong>IDR</strong> ID requester</p>
<p><strong>IDV</strong> ID validator</p>
<p><strong>Scope request ID</strong> uuid for PII request made by IDR to IDV, on the blockchain represented by bytes32 string (64 hex chars) </p>
<p><strong>Credential item</strong> Single piece of PII, can be claim (atom) or credential (molecule)</p>
<p><strong>Credential item ID</strong> Credential items are identified by external or internal ID. Internal ID is stored in the blockchain (bytes32 string of 64 hex chars) and is keccak256 of external ID. External ID consists of Type, Name and Version, i.e. credential, ProofOfAge, v1.0. String representation uses dash as separator, i.e. credential-ProofOfIdentity-v1.0.</p>
<h3>Installing</h3><p>For development, fetch the library from github: <a href="https://github.com/civicteam/civic-tx">https://github.com/civicteam/civic-tx</a></p>
<p>The library is not listed on npmjs.org.</p>
<pre class="prettyprint source lang-js"><code>const CivicTx = require('civic-marketplace');</code></pre><h3>Asyncronous calls</h3><p>Library returns <code>Promise</code> on any async call. Use <code>async/await</code> or <code>.then().catch()</code> according to your environment.  </p>
<h3>Initialising</h3><p>Before using the library, you should:</p>
<pre class="prettyprint source lang-js"><code>const CivicTx = require('civic-marketplace');
const civictx = new CivicTx(web3);</code></pre><p>Where <code>web3</code> is a valid web3 object connected to a node.</p>
<h3>Configuration</h3><p>CivicTx is configured by the file config/<STAGE>.json, where STAGE is passed in as an environment variable.</p>
<p>Alternatively, it is possible to pass in config to the constructor:</p>
<pre class="prettyprint source lang-js"><code>const config = { ... };
const civictx = new CivicTx(web3, config);</code></pre><h3>Contracts</h3><p>Contract artifacts (JSON files produced by truffle containing contract name, ABI, bytecode (optionally), addresses on specified networks) should be kept under <code>./civic-tx/contracts/stage/</code> directory for both <code>dev</code> and <code>test</code> stages. 
For <code>prod</code> we are using <code>./civic-tx/contracts/v3</code> folder for artifacts and <code>config.contracts.addresses</code> for addresses on rinkeby.</p>
<p>If you are using this lib as a dependency, you still need to create <code>./civic-tx/contracts/stage/</code> folder (for dev/test) and download artifacts from AWS S3 bucket.</p>
<h3>Artifacts</h3><p>Contract artifacts for <code>dev</code> and <code>test</code> are stored in <code>marketplace-contract-artifacts</code> AWS S3 bucket's of <code>civic-dev</code> account <code>dev/</code> and <code>test/</code> folders accordingly. 
For prod artifacts <code>marketplace-prod-contract-artifacts</code> bucket's <code>prod/</code> folder is used in <code>civic-prod</code> account. To access those <code>assume-role</code> with <code>cloudwatch-in-prod</code> is sufficient.</p>
<h2>Usage</h2><h3>Structure</h3><p>The library is structured into these sub-modules:</p>
<p><code>civictx.id</code> for generating and managing keys </p>
<p><code>civictx.asserts</code> containing input validation functions</p>
<p><code>civictx.nonce</code> for managing nonces for externally signed transactions</p>
<p><code>civictx.tx</code> for creating transactions on smart contracts (used by other submodules, discouraged to use directly)</p>
<p><code>civictx.sender</code> for sending transactions to the blockchain (used by other submodules, discouraged to use directly)</p>
<p><code>civictx.pricing</code> for contributing and querying prices</p>
<p><code>civictx.coin</code> for transferring platform coin and querying balances</p>
<p><code>civictx.token</code> for transferring tokens and querying balances</p>
<p><code>civictx.transactionDetails</code> for looking up specific transaction details</p>
<p><code>civictx.escrow</code> for placing tokens into and releasing them from the escrow contract</p>
<p><code>civictx.idv-registry</code> for adding and managing registered IDVs</p>
<p><code>civictx.ontology</code> for managing the ontology of attestation types</p>
<p><code>civictx.logging</code> for configuring the logger</p>
<p><code>civictx.util</code> utilities for handling conversion between types, etc.</p>
<h3>Creating transactions</h3><p>Transaction object (rawTx) can be created by <code>civictx.tx</code> module. Nonce management is done by <code>civictx.nonce</code> module. It respects txpool and does acquire/release mechanism so you can create sequential chain of transactions in case you need to keep strict order of execution.</p>
<h3>Signing transactions</h3><p>Typically with <code>web3</code>, transactions are signed by a local rootstock/ethereum client node (with private keys being stored in the node). For phone and web apps, this is not ideal. We have elected to sign transactions in the library before submitting the transactions to a cluster of nodes.</p>
<p>The library makes no assumption about how this will be done. Functions that need to sign a transaction take a function that must return a promise:</p>
<pre class="prettyprint source lang-js"><code>const signingFunction = (address, rawTx) => {....};</code></pre><p>Parameter <code>address</code> is the address that should sign, <code>rawTx</code> is a JSON transactions (or array of JSON transactions)</p>
<p>This function asynchronously signs the transaction and returns it through the promise (if <code>rawTx</code> is an array, then the return type is an array of signed transactions). The returned value(s) will be passed to <code>web3.eth.sendRawTransaction</code>. A typical implementation is:</p>
<pre class="prettyprint source lang-js"><code>const EthTx = require('ethereumjs-tx')

// const rawTx = {nonce: &lt;>, gasLimit: &lt;>, to: &lt;>, value: &lt;>, ....}

const signingFunction = (address, rawTx) => {
    return new Promise ((resolve, reject) => {
        const ethtx = new EthTx(rawTx)
        ethtx.sign(Buffer.from(privateKey, 'hex'))
        const hex = ethtx.serialize().toString('hex');
        resolve(hex);
    });
}</code></pre><h3>Sending transactions</h3><p><code>civictx.sender</code> module is responsible for sending transactions. It accepts an object with tx parameters and uses <code>civictx.tx</code> to create transaction. If optional signTx parameter is passed, tx will be signed externally. <code>send</code> function returns a promise which resolves to tx hash and rejects in case something went wrong (i.e. signing failed, chainID is wrong, insufficient wei etc.).</p>
<h3>Mining transactions</h3><p><code>civictx.tx.waitForMine</code> function can be used to check that transaction was successfully mined. It expects a promise which resolves to a tx hash (return value of <code>civictx.sender.send</code> could be used) and polls the blockchain each 0.5 sec for 2 minutes until tx receipt is returned. Then it asserts that tx status is a success.</p></article>
    </section>






    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Tue Sep 25 2018 14:16:55 GMT+0200 (CEST) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>


</body>
</html>